# Sanity Check Workflow
#
# Fast checks to catch issues early:
# - Validates GitHub Actions workflow syntax with actionlint
# - Verifies repository hygiene (required files, executable scripts)
#
# This workflow is intentionally fast (<2 minutes) and runs on
# changes to .github/ directory.

name: Sanity

on:
  push:
    branches: [main]
    paths:
      - '.github/**'
      - 'scripts/**'
      - 'Makefile'
  pull_request:
    branches: [main]
    paths:
      - '.github/**'
      - 'scripts/**'
      - 'Makefile'

permissions:
  contents: read

jobs:
  actionlint:
    name: Actionlint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run actionlint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          ./actionlint -color

  repo-hygiene:
    name: Repository Hygiene
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check required files exist
        run: |
          set -euo pipefail

          echo "==> Checking required files..."

          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
            "CONTRIBUTING.md"
            "SECURITY.md"
            "CODE_OF_CONDUCT.md"
            "CHANGELOG.md"
            ".github/CODEOWNERS"
            ".github/PULL_REQUEST_TEMPLATE.md"
            ".github/dependabot.yml"
            "Makefile"
            "docs/style_guide.md"
            "docs/testing_policy.md"
            "docs/release_process.md"
            "docs/security_baseline.md"
          )

          MISSING=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              MISSING+=("$file")
            fi
          done

          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo ""
            echo "ERROR: Missing required files:"
            printf '  - %s\n' "${MISSING[@]}"
            echo ""
            exit 1
          fi

          echo "All required files present"

      - name: Check scripts are executable
        run: |
          set -euo pipefail

          echo "==> Checking script permissions..."

          SCRIPTS=(
            "scripts/bootstrap.sh"
            "scripts/fmt.sh"
            "scripts/lint.sh"
            "scripts/test.sh"
            "scripts/build.sh"
            "scripts/ci.sh"
            "scripts/pr_title_check.sh"
          )

          NON_EXECUTABLE=()
          for script in "${SCRIPTS[@]}"; do
            if [[ -f "$script" ]] && [[ ! -x "$script" ]]; then
              NON_EXECUTABLE+=("$script")
            fi
          done

          if [[ ${#NON_EXECUTABLE[@]} -gt 0 ]]; then
            echo ""
            echo "ERROR: Scripts are not executable:"
            printf '  - %s\n' "${NON_EXECUTABLE[@]}"
            echo ""
            echo "Fix with: chmod +x scripts/*.sh"
            exit 1
          fi

          echo "All scripts are executable"

      - name: Check Makefile targets exist
        run: |
          set -euo pipefail

          echo "==> Checking Makefile targets..."

          REQUIRED_TARGETS=(
            "bootstrap"
            "fmt"
            "fmt-check"
            "lint"
            "test"
            "build"
            "ci"
            "clean"
            "help"
          )

          MISSING=()
          for target in "${REQUIRED_TARGETS[@]}"; do
            if ! grep -qE "^${target}:" Makefile; then
              MISSING+=("$target")
            fi
          done

          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo ""
            echo "ERROR: Missing Makefile targets:"
            printf '  - %s\n' "${MISSING[@]}"
            echo ""
            exit 1
          fi

          echo "All required Makefile targets exist"
